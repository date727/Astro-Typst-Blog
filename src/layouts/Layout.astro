<!doctype html>
<html lang="zh-cn">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title><slot name="title" /></title>

		<!-- 字体预加载 - 使用woff2格式以获得最佳性能 -->
		<link 
			rel="preload" 
			href="/fonts/consola-1.woff2"
			as="font" 
			type="font/woff2" 
			crossorigin 
		/>

		<style>
			/* 字体声明 - 使用swap策略确保内容立即可见 */
			@font-face {
				font-family: 'MyConsola';
				src: url('/fonts/consola-1.woff2') format('woff2');
				font-weight: normal;
				font-style: normal;
				font-display: swap; /* 关键：使用swap策略避免阻塞 */
				font-stretch: normal;
				unicode-range: U+000-5FF; /* 优化字符范围 */
			}

			/* 基础样式设置 */
			:root {
				--transition-speed: 0.25s;
				--content-delay: 0.05s;
				--font-fallback: 'Courier New', 'Monaco', monospace;
			}

			body {
				margin: 0;
				background-color: #fafaf0;
				font-family: 'MyConsola', var(--font-fallback);
				visibility: visible;
				opacity: 1;
			}

			nav {
				padding: 1.5rem 1rem;
				max-width: 800px;
				margin: 0 auto;
				text-align: right;
				border-bottom: 1px solid rgb(0, 128, 128);
				position: relative;
				z-index: 10;
			}

			nav a {
				margin-right: 1rem;
				text-decoration: none;
				font-weight: bold;
				color: #333;
				transition: color 0.2s ease;
				font-family: inherit;
			}

			nav a:hover {
				color: rgb(0, 128, 128);
			}

			/* 主内容区域样式 */
			main {
				padding: 2rem;
				max-width: 800px;
				margin: 0 auto;
				/* 初始状态 */
				opacity: 0;
				transform: translateY(8px);
				/* 平滑过渡 */
				transition: 
					opacity var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1),
					transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
				transition-delay: var(--content-delay);
				/* 使用后备字体直到自定义字体加载完成 */
				font-family: var(--font-fallback);
			}

			/* 页面内容显示状态 */
			.content-visible main {
				opacity: 1;
				transform: translateY(0);
				/* 字体加载完成后应用自定义字体 */
				font-family: 'MyConsola', var(--font-fallback);
			}

			/* 页面切换时的过渡状态 */
			.page-transitioning main {
				opacity: 0;
				transform: translateY(-8px);
			}

			/* 字体加载状态指示器（可选） */
			.font-status {
				position: fixed;
				top: 12px;
				right: 12px;
				width: 6px;
				height: 6px;
				border-radius: 50%;
				background-color: #e0e0e0;
				transition: all 0.3s ease;
				z-index: 1000;
			}

			.font-status.loading {
				background-color: #ff9800;
				box-shadow: 0 0 8px rgba(255, 152, 0, 0.6);
			}

			.font-status.loaded {
				background-color: #4caf50;
				box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
			}

			/* 优化字体加载体验 */
			@supports (font-display: swap) {
				body {
					/* 现代浏览器优化 */
					font-synthesis: none;
					text-rendering: optimizeLegibility;
				}
			}
		</style>
	</head>
	<body>
		<!-- 字体状态指示器 -->
		<div class="font-status loading"></div>
		
		<nav>
			<a href="/">Home</a>
			<a href="/about/">About</a>
			<a href="/blog/">Blog</a>
			<a href="/comments">Comment</a>
		</nav>

		<main>
			<slot />
		</main>

		<script>
			// 优化的字体和页面管理器
			const AppManager = {
				fontLoaded: false,
				contentVisible: false,
				
				init() {
					// 立即显示内容，使用后备字体
					this.showContent();
					
					// 异步加载自定义字体
					this.loadCustomFont();
					
					// 设置页面导航
					this.setupNavigation();
				},
				
				// 立即显示内容
				showContent() {
					if (!this.contentVisible) {
						this.contentVisible = true;
						document.body.classList.add('content-visible');
					}
				},
				
				// 加载自定义字体
				async loadCustomFont() {
					try {
						// 使用FontFace API进行精确控制
						if ('fonts' in document) {
							const font = new FontFace(
								'MyConsola',
								'url(/fonts/consola-1.woff2)',
								{ display: 'swap' }
							);
							
							await font.load();
							document.fonts.add(font);
							
							// 字体加载完成
							this.onFontLoaded();
						} else {
							// 降级处理
							setTimeout(() => this.onFontLoaded(), 100);
						}
					} catch (error) {
						console.warn('字体加载失败:', error);
						this.onFontLoaded(); // 继续执行
					}
				},
				
				// 字体加载完成处理
				onFontLoaded() {
					this.fontLoaded = true;
					
					// 更新状态指示器
					const indicator = document.querySelector('.font-status');
					if (indicator) {
						indicator.classList.remove('loading');
						indicator.classList.add('loaded');
						
						// 3秒后隐藏指示器
						setTimeout(() => {
							indicator.style.opacity = '0';
							setTimeout(() => {
								indicator.style.display = 'none';
							}, 300);
						}, 3000);
					}
					
					// 重新应用内容可见性以使用新字体
					if (this.contentVisible) {
						document.body.classList.remove('content-visible');
						// 使用requestAnimationFrame确保平滑过渡
						requestAnimationFrame(() => {
							document.body.classList.add('content-visible');
						});
					}
				},
				
				// 设置页面导航
				setupNavigation() {
					const navLinks = document.querySelectorAll('nav a');
					
					navLinks.forEach(link => {
						link.addEventListener('click', (e) => {
							// 如果是外部链接，不处理过渡
							if (link.getAttribute('target') === '_blank') return;
							
							const href = link.getAttribute('href');
							if (!href || href.startsWith('#')) return;
							
							e.preventDefault();
							
							// 开始页面过渡
							document.body.classList.add('page-transitioning');
							
							// 延迟导航以允许过渡动画完成
							setTimeout(() => {
								window.location.href = href;
							}, 250);
						});
					});
				}
			};

			// 页面加载完成后初始化
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', () => AppManager.init());
			} else {
				AppManager.init();
			}
		</script>
	</body>
</html>